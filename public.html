<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OurCraveBook â€” Creator Page</title>
  <meta name="description" content="Explore creator wishlists on OurCraveBook and support their goals." />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="public">
  <header class="app-header">
    <div class="brand"><span class="brand-glyph">ðŸ’‹</span><a class="brand-name" href="/">OurCraveBook</a></div>
    <nav class="actions"><a href="/" class="btn ghost">Create your own</a></nav>
  </header>
  <section class="public-hero">
    <img id="pubAvatar" class="pub-avatar" alt="Avatar" />
    <h2 id="pubName">Creator</h2>
    <p id="pubBio" class="muted"></p>
    <div class="pub-socials" id="pubSocials"></div>
  </section>
  <main class="wishlist-section">
    <h3 id="pubTitle">Wishlist</h3>
    <div id="pubSections"></div>
    <ul id="pubList" class="wishlist"></ul>
  </main>
  <footer class="app-footer"><p class="muted">ðŸ’Œ Want your own? Visit OurCraveBook.</p></footer>
  <script src="firebase-config.js" type="module"></script>
  <script type="module">
    import { db, storage } from "./firebase-config.js";
    import { doc, getDoc, collection, query, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
    import { getDownloadURL, ref } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

    const qs = new URLSearchParams(location.search);
    const uid = qs.get("user");
    if(!uid){ document.getElementById('pubTitle').textContent = "No user specified"; throw new Error("missing uid") }

    function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.textContent = text;
    }

    async function load(){
      const profSnap = await getDoc(doc(db, "users", uid, "meta", "profile"));
      if (profSnap.exists()){
        const p = profSnap.data();
        setText("pubName", p.displayName || "Creator");
        setText("pubBio", p.bio || "");
        if (p.avatarPath){
          try{
            const url = await getDownloadURL(ref(storage, p.avatarPath));
            const encodedUrl = encodeURIComponent(url);
            document.getElementById("pubAvatar").src = `/_next/image?url=${encodedUrl}&w=256&q=75`;
          }catch{}
        }
        const socialsEl = document.getElementById("pubSocials");
        socialsEl.innerHTML = '';
        const socials = [];
        if (p.ig) socials.push({ href: `https://instagram.com/${p.ig.replace('@','')}`, text: 'Instagram' });
        if (p.tw) socials.push({ href: `https://x.com/${p.tw.replace('@','')}`, text: 'X' });
        if (p.of) socials.push({ href: p.of, text: 'OnlyFans' });
        if (p.web) socials.push({ href: p.web, text: 'Website' });
        socials.forEach((link, index) => {
            const a = document.createElement('a'); a.href = link.href; a.target = '_blank'; a.textContent = link.text;
            socialsEl.appendChild(a);
            if (index < socials.length - 1) { socialsEl.appendChild(document.createTextNode(' Â· ')); }
        });
      }

      const snap = await getDocs(query(collection(db,"users",uid,"wishlist"), orderBy("order","asc")));
      const byCat = {};
      snap.forEach(d=>{ const it=d.data(); const c=it.category||"General"; (byCat[c]=byCat[c]||[]).push({id:d.id, ...it}); });
      const wrap = document.getElementById("pubSections"); wrap.innerHTML = "";
      Object.keys(byCat).sort().forEach(cat=>{
        const h = document.createElement('h4'); h.className="section-header"; h.textContent = cat; wrap.appendChild(h);
        const ul = document.createElement('ul'); ul.className="wishlist"; wrap.appendChild(ul);
        byCat[cat].forEach(it=>{
          const li = document.createElement("li");
          if (it.image) {
            const img = document.createElement('img'); img.className = 'item-img';
            const encodedUrl = encodeURIComponent(it.image); img.src = `/_next/image?url=${encodedUrl}&w=128&q=75`;
            img.alt = it.title || "Wishlist item"; li.appendChild(img);
          }
          const itemDiv = document.createElement('div'); itemDiv.style.flex = '1';
          const titleLink = document.createElement('a'); titleLink.href = it.url; titleLink.target = '_blank'; titleLink.rel = 'noopener'; titleLink.textContent = it.title || it.url;
          itemDiv.appendChild(titleLink);
          if (it.notes) {
            const notesDiv = document.createElement('div'); notesDiv.className = 'muted'; notesDiv.style.fontSize = '.85rem';
            notesDiv.textContent = it.notes; itemDiv.appendChild(notesDiv);
          }
          const contributed = it.contributed || 0; const goalCents = it.price ? it.price*100 : null;
          if (goalCents) {
            const pct = Math.min(100, Math.round((contributed/goalCents)*100));
            const progress = document.createElement('div'); progress.className = 'progress'; progress.style.marginTop = '.4rem';
            const progressFill = document.createElement('div'); progressFill.style.width = `${pct}%`;
            progress.appendChild(progressFill); itemDiv.appendChild(progress);
          }
          li.appendChild(itemDiv);
          if (it.price) {
            const priceSpan = document.createElement('span'); priceSpan.className = 'muted';
            priceSpan.textContent = `$${it.price}`; li.appendChild(priceSpan);
          }
          ul.appendChild(li);
        });
      });
    }
    load();
  </script>
</body>
</html>
